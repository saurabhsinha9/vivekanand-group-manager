
version: "1"

projects:
  - name: Vivekanand-gayaji-prod
    environments:
      - name: Production
        services:

          # --- Backend (Spring Boot, Docker runtime) ---
          - type: web
            name: vivekanand-manager-backend
            runtime: docker
            plan: free
            region: singapore
            repo: https://github.com/saurabhsinha9/vivekanand-group-manager
            rootDir: backend
            dockerContext: .
            dockerfilePath: Dockerfile
            healthCheckPath: /actuator/health
            autoDeployTrigger: commit
            envVars:
              # DB creds sourced from the database resource (secure; no secrets in code)
              - key: DB_URL
                fromDatabase:
                  name: vivekanand-manager-db
                  property: connectionString
              - key: DB_USER
                fromDatabase:
                  name: vivekanand-manager-db
                  property: user
              - key: DB_PASS
                fromDatabase:
                  name: vivekanand-manager-db
                  property: password

              # Non-sensitive defaults
              - key: SPRING_PROFILES_ACTIVE
                value: prod
              - key: SPRING_APP_NAME
                value: Vivekanand-Manager
              - key: PORT
                value: "10000"
              - key: SWAGGER_UI_PATH
                value: /swagger-ui.html
              - key: SPRINGDOC_API_ENABLED
                value: "true"
              - key: JPA_DDL_AUTO
                value: update
              - key: JPA_SHOW_SQL
                value: "false"
              - key: HIBERNATE_FORMAT_SQL
                value: "true"
              - key: MULTIPART_MAX_FILE_SIZE
                value: 100MB
              - key: MULTIPART_MAX_REQUEST_SIZE
                value: 100MB
              - key: UPLOAD_DIR
                value: /app/uploads
              - key: UPLOAD_MAX_MB
                value: "100"

              # Secrets injected from GitHub (do not commit values)
              - key: CORS_ALLOWED_ORIGINS
                sync: false
              - key: EMAIL_API_URL
                sync: false
              - key: EMAIL_API_KEY
                sync: false
              - key: JWT_SECRET
                sync: false
              - key: CLOUDINARY_API_KEY
                sync: false
              - key: CLOUDINARY_API_SECRET
                sync: false
              - key: CLOUDINARY_CLOUD_NAME
                sync: false

          # --- Frontend (Static Vite) ---
          - type: web
            name: vgm-fronend
            runtime: static
            plan: free
            region: singapore
            repo: https://github.com/saurabhsinha9/vivekanand-group-manager
            rootDir: frontend/
            buildCommand: npm install && npm run build
            staticPublishPath: dist
            autoDeployTrigger: commit
            routes:
              - type: rewrite
                source: /*
                destination: /index.html
            envVars:
              - key: VITE_API_URL
                sync: false   # injected from GitHub Secrets before build

          # --- Backup Cron (rclone â†’ Google Drive) ---
          - type: cron
            name: vgm-db-backup-job
            runtime: docker
            plan: free
            region: singapore
            repo: https://github.com/saurabhsinha9/vivekanand-group-manager
            rootDir: ops/backup
            dockerContext: .
            dockerfilePath: Dockerfile
            schedule: "0 21 * * *"   # daily at 21:00 UTC (~02:30 IST next day)
            envVars:
              - key: DB_URL
                fromDatabase:
                  name: vivekanand-manager-db
                  property: connectionString
              - key: DB_USER
                fromDatabase:
                  name: vivekanand-manager-db
                  property: user
              - key: DB_PASS
                fromDatabase:
                  name: vivekanand-manager-db
                  property: password
              - key: RCLONE_CONFIG
                sync: false
              - key: GDRIVE_REMOTE
                sync: false
              - key: BACKUP_RETENTION_DAYS
                value: "14"

          # --- Restore Worker (Docker; used by one-off job in rotation) ---
          - type: worker
            name: vgm-restore-worker
            runtime: docker
            plan: free
            region: singapore
            repo: https://github.com/saurabhsinha9/vivekanand-group-manager
            rootDir: ops/restore
            dockerContext: .
            dockerfilePath: Dockerfile
            autoDeployTrigger: commit
            envVars:
              - key: RCLONE_CONFIG
                sync: false
              - key: GDRIVE_REMOTE
                sync: false
              # Set by rotation workflow on demand:
              - key: NEW_DB_URL
                sync: false
              - key: NEW_DB_USER
                sync: false
              - key: NEW_DB_PASS
                sync: false

        databases:
          - name: vivekanand-manager-db
            plan: free
            region: singapore
            ipAllowList:
              - source: 0.0.0.0/0
                description: everywhere
            postgresMajorVersion: "18"
